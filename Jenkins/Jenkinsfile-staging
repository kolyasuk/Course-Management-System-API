pipeline{
    agent any
    tools{
        gradle 'Gradle'
    }
    stages{
        stage("build jar"){
            steps{
                echo 'building the staging application...'
                sh './gradlew clean build --no-daemon'
            }
        }
        
       stage("build docker"){
            steps{
                echo 'building docker...'
                sh 'docker build -f src/main/docker/Dockerfile -t cms-api:latest .' 
                sh 'docker tag cms-api dzioba/cms-api:latest'
            }
        }
        
       stage("publish image to Docker Hub"){
            steps{
                echo 'publishing docker...'
                sh  'docker push dzioba/cms-api:latest'
            }
        }

        stage("move jar"){
            steps{
                echo 'moving jar file...'
                sh 'scp -o StrictHostKeyChecking=no -i ../awskey.pem build/libs/CMS-API-1.0-SNAPSHOT.jar ' +
                'ec2-user@ec2-18-194-1-142.eu-central-1.compute.amazonaws.com:/home/ec2-user'
            }
        }
        
       stage("execute jar"){
            steps{
                echo 'executing jar file...'
                sh '''ssh -i ../awskey.pem ec2-user@ec2-18-194-1-142.eu-central-1.compute.amazonaws.com << EOT
                kill -9 java
                java -jar CMS-API-1.0-SNAPSHOT.jar
                exit
                EOT'''
            }
        }
    }
}
