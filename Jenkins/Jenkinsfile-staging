pipeline{
    agent any
    tools{
        gradle 'Gradle'
    }
    stages{
        stage("Build jar"){
            steps{
                echo 'building the staging application...'
                bat './gradlew clean build'
            }
        }
        
       stage("Build docker"){
            steps{
                echo 'building docker...'
                bat 'docker build -f src/main/docker/Dockerfile -t cms-api:latest .' 
                bat 'docker tag cms-api dzioba/cms-api:latest'
            }
        }
        
       stage("Publish image to Docker Hub"){
            steps{
                echo 'publishing docker...'
                withDockerRegistry([ credentialsId: "docker-hub-credentials", url: "" ]) {
                    bat 'docker push dzioba/cms-api:latest'
                }
            }
        }
        
       stage('Run Docker container') {
            steps {
                echo 'running docker image...'
                bat 'ssh -i C://Users//dziob//Desktop//aws//awskey.pem ec2-user@ec2-18-184-98-187.eu-central-1.compute.amazonaws.com '+
                '"docker rm $(docker stop cms-api); docker run --name cms-api -d -p 8080:8080 dzioba/cms-api"'
                bat 'exit'
            }
        }
    }
}
